name: rag-bootstrap

services:
  # 1. Ğ˜Ğ½Ñ„Ñ€Ğ°ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ°
  qdrant:
    image: qdrant/qdrant:v1.12.4
    container_name: qdrant-bootstrap
    ports:
      - "6333:6333"
    volumes:
      - rag_qdrant_storage:/qdrant/storage
    networks:
      - rag_network

  redis:
    image: redis:7.4.2-alpine
    container_name: redis-bootstrap
    volumes:
      - rag_redis_data:/data
    networks:
      - rag_network

  # 2. Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ñ‡Ğ¸Ğº Ğ¸ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ĞµÑ€
  bootstrap-loader:
    image: medphisiker/rag-backup-downloader:v001
    build:
      context: ./backup_downloader
    volumes:
      - .:/backups
      - rag_redis_data:/redis_data
    environment:
      - QDRANT_URL=http://qdrant:6333
    depends_on:
      - qdrant
      - redis
    networks:
      - rag_network
    entrypoint: >
      sh -c "
      echo 'ğŸ“¥ Downloading backups...';
      uv run python download.py;
      
      echo 'â³ Waiting for Qdrant...';
      for i in $(seq 1 30); do
        if curl -s http://qdrant:6333/ | grep -q 'qdrant'; then
          echo 'âœ… Qdrant is ready!';
          break
        fi
        echo \"ğŸ“¡ Qdrant not ready yet (attempt $$i/30)...\";
        sleep 5;
        if [ $$i -eq 30 ]; then echo 'âŒ Qdrant timeout!'; exit 1; fi
      done;
      
      echo 'ğŸš€ Importing Qdrant Snapshot...';
      curl -X POST 'http://qdrant:6333/collections/yandex_handbook_child_chunks/snapshots/upload?priority=snapshot' -H 'Content-Type: multipart/form-data' -F 'snapshot=@/backups/qdrant_backup.snapshot';
      
      echo 'ğŸ“¦ Extracting Redis RDB...';
      tar xzf /backups/redis_backup.tar.gz -C /redis_data;
      
      echo 'âœ… Bootstrap completed successfully!';"

networks:
  rag_network:
    name: rag_rag_network
    external: true

volumes:
  rag_qdrant_storage:
    external: true
  rag_redis_data:
    external: true