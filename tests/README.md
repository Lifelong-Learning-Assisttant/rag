# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ü–µ–Ω–∫–∞ RAG —Å–∏—Å—Ç–µ–º—ã

–≠—Ç–æ—Ç –º–æ–¥—É–ª—å —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞—Ç–∞—Å–µ—Ç –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ RAG —Å–∏—Å—Ç–µ–º—ã –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ –Ø–Ω–¥–µ–∫—Å–∞ –ø–æ –º–∞—à–∏–Ω–Ω–æ–º—É –æ–±—É—á–µ–Ω–∏—é.

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞

```
tests/
‚îú‚îÄ‚îÄ dataset.json              # –î–∞—Ç–∞—Å–µ—Ç —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ –∏ –æ–∂–∏–¥–∞–µ–º—ã–º–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
‚îú‚îÄ‚îÄ evaluate_rag.py          # –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ RAG
‚îú‚îÄ‚îÄ evaluation_results.json  # –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ü–µ–Ω–∫–∏ (–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è)
‚îî‚îÄ‚îÄ README.md               # –≠—Ç–æ—Ç —Ñ–∞–π–ª
```

## üìä –î–∞—Ç–∞—Å–µ—Ç

–î–∞—Ç–∞—Å–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç 20 –≤–æ–ø—Ä–æ—Å–æ–≤ —Ä–∞–∑–Ω–æ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:

### –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –≤–æ–ø—Ä–æ—Å–æ–≤:
- **definition** - –≤–æ–ø—Ä–æ—Å—ã –Ω–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–Ω—è—Ç–∏–π
- **explanation** - –≤–æ–ø—Ä–æ—Å—ã, —Ç—Ä–µ–±—É—é—â–∏–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è
- **comparison** - –≤–æ–ø—Ä–æ—Å—ã –Ω–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ
- **problem_solution** - –≤–æ–ø—Ä–æ—Å—ã –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö –∏ —Ä–µ—à–µ–Ω–∏—è—Ö

### –£—Ä–æ–≤–Ω–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:
- **easy** - –ø—Ä–æ—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã (–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è, –±–∞–∑–æ–≤—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏)
- **medium** - —Å—Ä–µ–¥–Ω–∏–µ –≤–æ–ø—Ä–æ—Å—ã (–æ–±—ä—è—Å–Ω–µ–Ω–∏—è, –º–µ—Ö–∞–Ω–∏–∑–º—ã)
- **hard** - —Å–ª–æ–∂–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã (–≥–ª—É–±–æ–∫–∏–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏, –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞)

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤–æ–ø—Ä–æ—Å–∞:

```json
{
  "question": "–ß—Ç–æ —Ç–∞–∫–æ–µ –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π –±—É—Å—Ç–∏–Ω–≥?",
  "expected_topics": ["–≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π –±—É—Å—Ç–∏–Ω–≥", "–∞–Ω—Å–∞–º–±–ª–∏", "–¥–µ—Ä–µ–≤—å—è —Ä–µ—à–µ–Ω–∏–π"],
  "expected_source": "gradientnyj-busting.md",
  "category": "definition",
  "difficulty": "easy"
}
```

## üöÄ –ó–∞–ø—É—Å–∫ –æ—Ü–µ–Ω–∫–∏

### –ë–∞–∑–æ–≤—ã–π –∑–∞–ø—É—Å–∫ (–≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã):

```bash
cd /home/llm-dev/project/lifelong_learning_assistant/rag
python tests/evaluate_rag.py
```

### –° –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º HyDE:

```bash
python tests/evaluate_rag.py --hyde
```

### –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–ø—Ä–æ—Å–æ–≤:

```bash
python tests/evaluate_rag.py --limit 5
```

### –£–∫–∞–∑–∞—Ç—å —Å–≤–æ–π –¥–∞—Ç–∞—Å–µ—Ç:

```bash
python tests/evaluate_rag.py --dataset my_dataset.json --output my_results.json
```

### –í—Å–µ –æ–ø—Ü–∏–∏:

```bash
python tests/evaluate_rag.py \
  --dataset tests/dataset.json \
  --output tests/evaluation_results.json \
  --hyde \
  --limit 10
```

## üìà –ú–µ—Ç—Ä–∏–∫–∏

–°–∫—Ä–∏–ø—Ç –≤—ã—á–∏—Å–ª—è–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ –º–µ—Ç—Ä–∏–∫–∏:

### üîç –ú–µ—Ç—Ä–∏–∫–∏ –ø–æ–∏—Å–∫–∞ (Retrieval):

1. **Source Found Rate** - –ø—Ä–æ—Ü–µ–Ω—Ç –≤–æ–ø—Ä–æ—Å–æ–≤, –¥–ª—è –∫–æ—Ç–æ—Ä—ã—Ö –Ω–∞–π–¥–µ–Ω –æ–∂–∏–¥–∞–µ–º—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫
2. **Topic Coverage** - –ø–æ–∫—Ä—ã—Ç–∏–µ –æ–∂–∏–¥–∞–µ–º—ã—Ö —Ç–æ–ø–∏–∫–æ–≤ –≤ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö
3. **Average Score Top-3** - —Å—Ä–µ–¥–Ω–∏–π —Å–∫–æ—Ä —Ç–æ–ø-3 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (—á–µ–º –º–µ–Ω—å—à–µ, —Ç–µ–º –ª—É—á—à–µ)
4. **Average Docs Retrieved** - —Å—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

### üìù –ú–µ—Ç—Ä–∏–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (Generation):

1. **Average Answer Length** - —Å—Ä–µ–¥–Ω—è—è –¥–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞ –≤ —Å–∏–º–≤–æ–ª–∞—Ö
2. **Topic Coverage in Answer** - –ø–æ–∫—Ä—ã—Ç–∏–µ –æ–∂–∏–¥–∞–µ–º—ã—Ö —Ç–æ–ø–∏–∫–æ–≤ –≤ –æ—Ç–≤–µ—Ç–µ
3. **Structured Answers Rate** - –ø—Ä–æ—Ü–µ–Ω—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ (—Å–æ —Å–ø–∏—Å–∫–∞–º–∏, –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏)
4. **Russian Ratio** - –¥–æ–ª—è —Ä—É—Å—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –≤ –æ—Ç–≤–µ—Ç–µ

### ‚ö° –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:

1. **Average Generation Time** - —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞
2. **Average Tokens Context** - —Å—Ä–µ–¥–Ω–∏–π —Ä–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤ —Ç–æ–∫–µ–Ω–∞—Ö

### üìä –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏:

- –ú–µ—Ç—Ä–∏–∫–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –≤–æ–ø—Ä–æ—Å–æ–≤
- –ú–µ—Ç—Ä–∏–∫–∏ –ø–æ —É—Ä–æ–≤–Ω—è–º —Å–ª–æ–∂–Ω–æ—Å—Ç–∏

## üìÑ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ JSON —Ñ–∞–π–ª —Å–æ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π:

```json
{
  "results": [
    {
      "question": "...",
      "category": "...",
      "difficulty": "...",
      "retrieval": {
        "source_found": true,
        "topic_coverage": 0.8,
        "avg_score_top3": 0.234,
        ...
      },
      "generation": {
        "answer_length": 450,
        "topic_coverage_answer": 0.9,
        ...
      },
      "answer": "..."
    }
  ],
  "aggregate_metrics": {
    "overall": {...},
    "retrieval": {...},
    "generation": {...},
    "performance": {...},
    "by_category": {...},
    "by_difficulty": {...}
  }
}
```

## üéØ –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

### –•–æ—Ä–æ—à–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏:

- **Source Found Rate** > 70% - —Å–∏—Å—Ç–µ–º–∞ –Ω–∞—Ö–æ–¥–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏
- **Topic Coverage** > 60% - –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã
- **Average Score Top-3** < 0.5 - –≤—ã—Å–æ–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –ø–æ–∏—Å–∫–∞
- **Topic Coverage in Answer** > 70% - –æ—Ç–≤–µ—Ç—ã –ø–æ–∫—Ä—ã–≤–∞—é—Ç –Ω—É–∂–Ω—ã–µ —Ç–æ–ø–∏–∫–∏
- **Russian Ratio** > 95% - –æ—Ç–≤–µ—Ç—ã –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
- **Structured Answers Rate** > 50% - –æ—Ç–≤–µ—Ç—ã —Ö–æ—Ä–æ—à–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω—ã

### –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏:

- **Source Found Rate** < 50% - –ø—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–∏—Å–∫–æ–º
- **Topic Coverage** < 40% - –Ω–∏–∑–∫–∞—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å
- **Average Score Top-3** > 0.7 - —Å–ª–∞–±–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –ø–æ–∏—Å–∫–∞
- **Answer Length** < 100 - —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–µ –æ—Ç–≤–µ—Ç—ã
- **Russian Ratio** < 80% - –ø—Ä–æ–±–ª–µ–º—ã —Å —è–∑—ã–∫–æ–º

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞

–í—ã –º–æ–∂–µ—Ç–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –æ—Ü–µ–Ω–∫–∏, —Ä–µ–¥–∞–∫—Ç–∏—Ä—É—è:

1. **dataset.json** - –¥–æ–±–∞–≤–∏—Ç—å/–∏–∑–º–µ–Ω–∏—Ç—å –≤–æ–ø—Ä–æ—Å—ã
2. **evaluate_rag.py** - –∏–∑–º–µ–Ω–∏—Ç—å –ª–æ–≥–∏–∫—É –æ—Ü–µ–Ω–∫–∏ –∏–ª–∏ –º–µ—Ç—Ä–∏–∫–∏
3. **app/config.py** - –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã RAG (top_k, score_threshold, –∏ —Ç.–¥.)

## üìù –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### 1. –ë—ã—Å—Ç—Ä–∞—è –æ—Ü–µ–Ω–∫–∞ –Ω–∞ 5 –≤–æ–ø—Ä–æ—Å–∞—Ö:

```bash
python tests/evaluate_rag.py --limit 5
```

### 2. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å HyDE –∏ –±–µ–∑:

```bash
# –ë–µ–∑ HyDE
python tests/evaluate_rag.py --output results_no_hyde.json

# –° HyDE
python tests/evaluate_rag.py --hyde --output results_with_hyde.json
```

### 3. –û—Ü–µ–Ω–∫–∞ —Ç–æ–ª—å–∫–æ —Å–ª–æ–∂–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤:

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `hard_questions.json` —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ "hard" –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ:

```bash
python tests/evaluate_rag.py --dataset hard_questions.json
```

## üêõ Troubleshooting

### –û—à–∏–±–∫–∞ "–ö–æ–ª–ª–µ–∫—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –∑–∞–ø—É—Å—Ç–∏–ª–∏ ETL –ø—Ä–æ—Ü–µ—Å—Å:

```bash
jupyter notebook notebook/rag_etl_loader.ipynb
# –í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ —è—á–µ–π–∫–∏
```

### –û—à–∏–±–∫–∞ "Redis/Qdrant –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"

–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å—ã:

```bash
docker-compose up -d qdrant redis
```

### –ú–µ–¥–ª–µ–Ω–Ω–∞—è –æ—Ü–µ–Ω–∫–∞

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `--limit` –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤–æ–ø—Ä–æ—Å–æ–≤:

```bash
python tests/evaluate_rag.py --limit 10
```

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

- [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è RAG API](../README.md)
- [–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è](../app/config.py)
- [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ RAG](../README.md#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-rag-pipeline)

